<?xml version="1.0" encoding="UTF-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Miroslav Batchkarov</title>
    <description>Miroslav Batchkarov&#39;s webspace</description>
    <link>http://mbatchkarov.github.io/</link>
    <atom:link href="http://mbatchkarov.github.io/feed.xml" rel="self" type="application/rss+xml" />
    <pubDate>Mon, 14 Jul 2014 21:01:48 +0100</pubDate>
    <lastBuildDate>Mon, 14 Jul 2014 21:01:48 +0100</lastBuildDate>
    <generator>Jekyll v2.1.1</generator>
    
      <item>
        <title>Profiling Python</title>
        <description>&lt;p&gt;This article explains the basics of profiling Python code. The hardest part is&lt;br /&gt;
installing all the great tools that make it trivial to find the bottleneck in&lt;br /&gt;
your code.&lt;/p&gt;

&lt;h2 id=&quot;getting-the-required-tools&quot;&gt;Getting the required tools&lt;/h2&gt;
&lt;p&gt;This can be a pain in the neck on a Mac. The rule of thumb I adhere to is &lt;strong&gt;Use
&lt;code&gt;conda&lt;/code&gt;, &lt;code&gt;pip&lt;/code&gt; and &lt;code&gt;homebrew&lt;/code&gt; where possible&lt;/strong&gt;.&lt;/p&gt;

&lt;h3 id=&quot;python-and-core-packages-numpy-scipy-etc&quot;&gt;Python and core packages (&lt;code&gt;numpy&lt;/code&gt;, &lt;code&gt;scipy&lt;/code&gt;, etc)&lt;/h3&gt;
&lt;p&gt;Installing Python modules can sometimes be challenging as these link to compiled
&lt;code&gt;C&lt;/code&gt;/&lt;code&gt;Fortran&lt;/code&gt; code behind the scenes. I recommend using &lt;code&gt;conda&lt;/code&gt;, which can&lt;br /&gt;
install pre-compiled modules for your operating system. Download from&lt;br /&gt;
http://conda.pydata.org/miniconda.html. &lt;code&gt;conda&lt;/code&gt; can be installed to your home&lt;br /&gt;
directory, which comes in handy on the cluster.&lt;/p&gt;

&lt;p&gt;After that, you can easily set up a virtual environment and install many of the core packages:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;conda create -n py3k anaconda python=3
conda install numpy
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The first step above should prepend the newly set up Python interpreter to your&lt;br /&gt;
path. If it doesn’t, prepend the path to the new interpreter by editing
&lt;code&gt;~/.bashrc&lt;/code&gt; and &lt;code&gt;~/.bash_profile&lt;/code&gt;. Pip should also be installed— if it is not,&lt;br /&gt;
type  the following into a terminal
&lt;code&gt;
conda install pip
&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;Once &lt;code&gt;conda&lt;/code&gt; and &lt;code&gt;pip&lt;/code&gt; are up and running, you should always attempt to install&lt;br /&gt;
new Python packages through them instead of from source. This will save a lot of&lt;br /&gt;
headache in the long run as you won’t have to compile &lt;code&gt;C&lt;/code&gt;/&lt;code&gt;Fortran&lt;/code&gt; code.&lt;/p&gt;

&lt;h4 id=&quot;note&quot;&gt;Note&lt;/h4&gt;
&lt;p&gt;Some Python packages serve as a wrapper around other software, such as &lt;code&gt;MySQLdb&lt;/code&gt;&lt;br /&gt;
around &lt;code&gt;mysql&lt;/code&gt; and &lt;code&gt;bsddb&lt;/code&gt; around &lt;code&gt;BerkeleyDB&lt;/code&gt;. The underlying software is best&lt;br /&gt;
installed via &lt;code&gt;homebrew&lt;/code&gt;. For instance, here is how to set up &lt;code&gt;BerkeleyDB&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;# install C/Fortran compilers, these will come in handy all the time
brew install gcc
# install berkeley to  /usr/local/Cellar/berkeley-db/&amp;lt;VERSION&amp;gt;
brew install berkeley-db
# install python wrapper, passing in the path to the berkeley-db installation
BERKELEYDB_DIR=/usr/local/Cellar/berkeley-db/5.3.15/ pip install bsddb3
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;profiling-result-visualisation-runsnakerun-snakeviz&quot;&gt;Profiling result visualisation (&lt;code&gt;Runsnakerun&lt;/code&gt;/ &lt;code&gt;Snakeviz&lt;/code&gt;)&lt;/h3&gt;

&lt;p&gt;These tool are useful for finding which function calls take the most time. You&lt;br /&gt;
cannot look inside of functions using these. The next section will explain how&lt;br /&gt;
to profile a single function to find which lines take the most time.&lt;/p&gt;

&lt;p&gt;I know of two great packages the can visualise the output of the Python&lt;br /&gt;
profiler. &lt;code&gt;snakeviz&lt;/code&gt; has some fancy features and written in pure Python. It is&lt;br /&gt;
easier to set up and use, but somewhat slow. If you have profiled a large chunk&lt;br /&gt;
of an application, &lt;code&gt;snakeviz&lt;/code&gt; will give up. In practice, I found it’s only&lt;br /&gt;
useful for small programs. &lt;code&gt;runsnakerun&lt;/code&gt; is written in &lt;code&gt;C&lt;/code&gt;, so it can display&lt;br /&gt;
just about anything, but is somewhat trickier to install.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;pip install snakeviz
pip install runsnakerun
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For &lt;code&gt;runsnakerun&lt;/code&gt;, you may also have to install &lt;code&gt;SquareMap&lt;/code&gt; via &lt;code&gt;brew&lt;/code&gt;/&lt;code&gt;conda&lt;/code&gt;/&lt;code&gt;pip&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;To visualise the results of a profiling run with &lt;code&gt;snakeviz&lt;/code&gt; type
&lt;code&gt;
snakeviz out.prof
&lt;/code&gt;&lt;br /&gt;
where &lt;code&gt;out.prof&lt;/code&gt; is the file output by the profiler (see below). If you get
“Sorry, we were not able to load this profile! You can try profiling a smaller&lt;br /&gt;
portion of your code.”, then you will have to use &lt;code&gt;runsnakerun&lt;/code&gt;:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;ipython qtconsole
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the window that opens, type
&lt;code&gt;
from runsnakerun import runsnake
runsnake.main()
&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;then use the GUI to open &lt;code&gt;out.prof&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;The reason we are using &lt;code&gt;ipython&lt;/code&gt; instead of launching &lt;code&gt;runsnakerun&lt;/code&gt; from the&lt;br /&gt;
terminal is that OSX restricts some applications’ access to the screen. The&lt;br /&gt;
version of &lt;code&gt;runsnakerun&lt;/code&gt; installed through &lt;code&gt;pip&lt;/code&gt; is not an Apple “framework” and&lt;br /&gt;
therefore cannot access the screen. There are multiple guides explaining how to&lt;br /&gt;
get around this on the Internet, but none of them has worked for me.&lt;/p&gt;

&lt;h3 id=&quot;ipython-extensions&quot;&gt;IPython extensions&lt;/h3&gt;

&lt;p&gt;There are many great tutorials on how to set up and use the required IPython&lt;br /&gt;
  extensions, such as http://pynash.org/2013/03/06/timing-and-profiling.html .&lt;/p&gt;

&lt;p&gt;These extensions are best used to profile single functions (see below). &lt;code&gt;lprun&lt;/code&gt;&lt;br /&gt;
and &lt;code&gt;mprun&lt;/code&gt; are of particular interest. Also note &lt;code&gt;prun&lt;/code&gt; prints as a table the&lt;br /&gt;
same information that &lt;code&gt;snakeviz&lt;/code&gt;/&lt;code&gt;runsnakerun&lt;/code&gt; visualises. Personally I find&lt;br /&gt;
the visualisation much more useful.&lt;/p&gt;

&lt;h2 id=&quot;profiling-the-entire-application&quot;&gt;Profiling the entire application&lt;/h2&gt;

&lt;p&gt;To profile an entire application, run
&lt;code&gt;
python -m cProfile -o out.prof mycode.py
&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;This creates a file called &lt;code&gt;out.prof&lt;/code&gt;, which can be visualised using &lt;code&gt;snakeviz&lt;/code&gt;&lt;br /&gt;
or &lt;code&gt;runsnakerun&lt;/code&gt;. The visualisation might like this:&lt;/p&gt;

&lt;!-- ![Image](https://dl.dropboxusercontent.com/u/20043416/runsnake.png) --&gt;
&lt;p&gt;&lt;img src=&quot;http://mbatchkarov.github.io/assets/images/runsnake.png&quot; alt=&quot;Image&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The top left corner of that image can be read as&lt;br /&gt;
 - function &lt;code&gt;_count_vocab&lt;/code&gt; took a total of 1.6s&lt;br /&gt;
 - 0.6s of which were spent in &lt;code&gt;__contains__&lt;/code&gt; (not visible in the image, you&lt;br /&gt;
   need to hover over the box in &lt;code&gt;runsnakerun&lt;/code&gt;)&lt;br /&gt;
 - 0.2s of which were spent in &lt;code&gt;__my_feature_extractor__&lt;/code&gt;, etc&lt;/p&gt;

&lt;p&gt;This technique can be used to find out which functions take a long time.&lt;/p&gt;

&lt;h2 id=&quot;profiling-functions&quot;&gt;Profiling functions&lt;/h2&gt;

&lt;p&gt;Having set up the required IPython extensions and identified bottleneck functions,&lt;br /&gt;
we can profile and incrementally optimise these. Let’s illustrate this with a real&lt;br /&gt;
example I was recently working on.&lt;/p&gt;

&lt;p&gt;I have a function called &lt;code&gt;calculate_log_odds&lt;/code&gt;, which does something rather&lt;br /&gt;
simple but seems to take a lot of time. To profile it line by line, I ran the&lt;br /&gt;
following command in IPython&lt;/p&gt;

&lt;div&gt;&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n1&quot; name=&quot;n1&quot;&gt;1&lt;/a&gt;&lt;/span&gt;&lt;span style=&quot;color:#777&quot;&gt;# get some data to run the function with&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n2&quot; name=&quot;n2&quot;&gt;2&lt;/a&gt;&lt;/span&gt;&lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;import&lt;/span&gt; &lt;span style=&quot;color:#B44;font-weight:bold&quot;&gt;pickle&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n3&quot; name=&quot;n3&quot;&gt;3&lt;/a&gt;&lt;/span&gt;b = pickle.load(&lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;open&lt;/span&gt;(&lt;span style=&quot;background-color:hsla(0,100%,50%,0.05)&quot;&gt;&lt;span style=&quot;color:#710&quot;&gt;&#39;&lt;/span&gt;&lt;span style=&quot;color:#D20&quot;&gt;../statistics/stats-exp0-0-cv0-ev.MultinomialNB.pkl&lt;/span&gt;&lt;span style=&quot;color:#710&quot;&gt;&#39;&lt;/span&gt;&lt;/span&gt;))
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n4&quot; name=&quot;n4&quot;&gt;4&lt;/a&gt;&lt;/span&gt;X = b.tr_matrix
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n5&quot; name=&quot;n5&quot;&gt;5&lt;/a&gt;&lt;/span&gt;y = b.y_tr
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n6&quot; name=&quot;n6&quot;&gt;6&lt;/a&gt;&lt;/span&gt;&lt;span style=&quot;color:#777&quot;&gt;# do the actual profiling&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n7&quot; name=&quot;n7&quot;&gt;7&lt;/a&gt;&lt;/span&gt;%lprun -f calculate_log_odds calculate_log_odds(X, y)
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The output looks like this:&lt;/p&gt;

&lt;div&gt;&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n1&quot; name=&quot;n1&quot;&gt;1&lt;/a&gt;&lt;/span&gt;Total time: &lt;span style=&quot;color:#60E&quot;&gt;2.36018&lt;/span&gt; s
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n2&quot; name=&quot;n2&quot;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n3&quot; name=&quot;n3&quot;&gt;3&lt;/a&gt;&lt;/span&gt;Line &lt;span style=&quot;color:#777&quot;&gt;#      Hits         Time  Per Hit   % Time  Line Contents&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n4&quot; name=&quot;n4&quot;&gt;4&lt;/a&gt;&lt;/span&gt;==============================================================
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n5&quot; name=&quot;n5&quot;&gt;5&lt;/a&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;3&lt;/span&gt;                                           &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color:#06B;font-weight:bold&quot;&gt;calculate_log_odds&lt;/span&gt;(X, y):
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n6&quot; name=&quot;n6&quot;&gt;6&lt;/a&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;4&lt;/span&gt;                                               &lt;span style=&quot;color:#777&quot;&gt;# todo this is quite slow&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n7&quot; name=&quot;n7&quot;&gt;7&lt;/a&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;5&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;           &lt;span style=&quot;color:#00D&quot;&gt;14&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;14.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      log_odds = np.empty(X.shape[&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;])
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n8&quot; name=&quot;n8&quot;&gt;8&lt;/a&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;6&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;           &lt;span style=&quot;color:#00D&quot;&gt;45&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;45.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      class0_indices = (y == &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;sorted&lt;/span&gt;(&lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;set&lt;/span&gt;(y))[&lt;span style=&quot;color:#00D&quot;&gt;0&lt;/span&gt;])
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n9&quot; name=&quot;n9&quot;&gt;9&lt;/a&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;7&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2466&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1632&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.7&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.1&lt;/span&gt;      &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;for&lt;/span&gt; idx &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;range&lt;/span&gt;(X.shape[&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;]):
&lt;span class=&quot;line-numbers&quot;&gt;&lt;strong&gt;&lt;a href=&quot;#n10&quot; name=&quot;n10&quot;&gt;10&lt;/a&gt;&lt;/strong&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;8&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;       &lt;span style=&quot;color:#00D&quot;&gt;864021&lt;/span&gt;    &lt;span style=&quot;color:#60E&quot;&gt;350.5&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;36.6&lt;/span&gt;          all_counts = X[:, idx].A.ravel()  &lt;span style=&quot;color:#777&quot;&gt;# document counts of this feature&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n11&quot; name=&quot;n11&quot;&gt;11&lt;/a&gt;&lt;/span&gt;     &lt;span style=&quot;color:#00D&quot;&gt;9&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;1378602&lt;/span&gt;    &lt;span style=&quot;color:#60E&quot;&gt;559.3&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;58.4&lt;/span&gt;          total_counts = &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;sum&lt;/span&gt;(all_counts &amp;gt; &lt;span style=&quot;color:#00D&quot;&gt;0&lt;/span&gt;)  &lt;span style=&quot;color:#777&quot;&gt;# how many docs the feature occurs in&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n12&quot; name=&quot;n12&quot;&gt;12&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;10&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;        &lt;span style=&quot;color:#00D&quot;&gt;79524&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;32.3&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;3.4&lt;/span&gt;          count_in_class0 = &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;sum&lt;/span&gt;(all_counts[class0_indices])  &lt;span style=&quot;color:#777&quot;&gt;# how many of them are class 0&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n13&quot; name=&quot;n13&quot;&gt;13&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;11&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;3871&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.6&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.2&lt;/span&gt;          p = &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;float&lt;/span&gt;(count_in_class0) / total_counts;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n14&quot; name=&quot;n14&quot;&gt;14&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;12&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;        &lt;span style=&quot;color:#00D&quot;&gt;29874&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;12.1&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.3&lt;/span&gt;          log_odds_this_feature = np.log(p) - np.log(&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt; - p)
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n15&quot; name=&quot;n15&quot;&gt;15&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;13&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;2595&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.1&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.1&lt;/span&gt;          log_odds[idx] = log_odds_this_feature
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n16&quot; name=&quot;n16&quot;&gt;16&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;14&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;            &lt;span style=&quot;color:#00D&quot;&gt;0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;return&lt;/span&gt; log_odds
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n17&quot; name=&quot;n17&quot;&gt;17&lt;/a&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Most of the time is spent on line 9, where I am using the Python &lt;code&gt;sum&lt;/code&gt; function&lt;br /&gt;
to add up a &lt;code&gt;numpy&lt;/code&gt; array. This can be made much faster by using the appropriate&lt;br /&gt;
numpy function:&lt;/p&gt;

&lt;div&gt;&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n1&quot; name=&quot;n1&quot;&gt;1&lt;/a&gt;&lt;/span&gt;Function: calculate_log_odds2 at line &lt;span style=&quot;color:#00D&quot;&gt;16&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n2&quot; name=&quot;n2&quot;&gt;2&lt;/a&gt;&lt;/span&gt;Total time: &lt;span style=&quot;color:#60E&quot;&gt;1.54092&lt;/span&gt; s
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n3&quot; name=&quot;n3&quot;&gt;3&lt;/a&gt;&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n4&quot; name=&quot;n4&quot;&gt;4&lt;/a&gt;&lt;/span&gt;Line &lt;span style=&quot;color:#777&quot;&gt;#      Hits         Time  Per Hit   % Time  Line Contents&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n5&quot; name=&quot;n5&quot;&gt;5&lt;/a&gt;&lt;/span&gt;==============================================================
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n6&quot; name=&quot;n6&quot;&gt;6&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;16&lt;/span&gt;                                           &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color:#06B;font-weight:bold&quot;&gt;calculate_log_odds2&lt;/span&gt;(X, y):
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n7&quot; name=&quot;n7&quot;&gt;7&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;17&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;           &lt;span style=&quot;color:#00D&quot;&gt;16&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;16.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      log_odds = np.empty(X.shape[&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;])
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n8&quot; name=&quot;n8&quot;&gt;8&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;18&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;           &lt;span style=&quot;color:#00D&quot;&gt;55&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;55.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      class0_indices = (y == &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;sorted&lt;/span&gt;(&lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;set&lt;/span&gt;(y))[&lt;span style=&quot;color:#00D&quot;&gt;0&lt;/span&gt;])
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n9&quot; name=&quot;n9&quot;&gt;9&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;19&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;          &lt;span style=&quot;color:#00D&quot;&gt;526&lt;/span&gt;    &lt;span style=&quot;color:#60E&quot;&gt;526.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      X = X.tocsc()
&lt;span class=&quot;line-numbers&quot;&gt;&lt;strong&gt;&lt;a href=&quot;#n10&quot; name=&quot;n10&quot;&gt;10&lt;/a&gt;&lt;/strong&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;20&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2466&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1746&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.7&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.1&lt;/span&gt;      &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;for&lt;/span&gt; idx &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;range&lt;/span&gt;(X.shape[&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;]):
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n11&quot; name=&quot;n11&quot;&gt;11&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;21&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;1417910&lt;/span&gt;    &lt;span style=&quot;color:#60E&quot;&gt;575.2&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;92.0&lt;/span&gt;          all_counts = X[:, idx].A.ravel()  &lt;span style=&quot;color:#777&quot;&gt;# document counts of this feature&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n12&quot; name=&quot;n12&quot;&gt;12&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;22&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;        &lt;span style=&quot;color:#00D&quot;&gt;49792&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;20.2&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;3.2&lt;/span&gt;          total_counts = np.sum(all_counts &amp;gt; &lt;span style=&quot;color:#00D&quot;&gt;0&lt;/span&gt;)  &lt;span style=&quot;color:#777&quot;&gt;# how many docs the feature occurs in&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n13&quot; name=&quot;n13&quot;&gt;13&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;23&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;        &lt;span style=&quot;color:#00D&quot;&gt;32936&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;13.4&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;2.1&lt;/span&gt;          count_in_class0 = np.sum(all_counts[class0_indices])  &lt;span style=&quot;color:#777&quot;&gt;# how many of them are class 0&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n14&quot; name=&quot;n14&quot;&gt;14&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;24&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;4377&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.8&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.3&lt;/span&gt;          p = &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;float&lt;/span&gt;(count_in_class0) / total_counts;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n15&quot; name=&quot;n15&quot;&gt;15&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;25&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;        &lt;span style=&quot;color:#00D&quot;&gt;30788&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;12.5&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;2.0&lt;/span&gt;          log_odds_this_feature = np.log(p) - np.log(&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt; - p)
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n16&quot; name=&quot;n16&quot;&gt;16&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;26&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;2769&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.1&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.2&lt;/span&gt;          log_odds[idx] = log_odds_this_feature
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n17&quot; name=&quot;n17&quot;&gt;17&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;27&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;            &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;return&lt;/span&gt; log_odds
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n18&quot; name=&quot;n18&quot;&gt;18&lt;/a&gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;Note the running time has gone down from 2.3s to 1.5s. Now the bottleneck of the&lt;br /&gt;
function seems to be at line 21, where I slice a sparse matrix and unnecessarily&lt;br /&gt;
convert to it a dense one. After a few more iterations of 1) find bottleneck line, and 2) correct line, I&lt;br /&gt;
arrived at the following:&lt;/p&gt;

&lt;div&gt;&lt;div class=&quot;CodeRay&quot;&gt;
  &lt;div class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n1&quot; name=&quot;n1&quot;&gt;1&lt;/a&gt;&lt;/span&gt;Total time: &lt;span style=&quot;color:#60E&quot;&gt;0.058181&lt;/span&gt; s
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n2&quot; name=&quot;n2&quot;&gt;2&lt;/a&gt;&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n3&quot; name=&quot;n3&quot;&gt;3&lt;/a&gt;&lt;/span&gt;Line &lt;span style=&quot;color:#777&quot;&gt;#      Hits         Time  Per Hit   % Time  Line Contents&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n4&quot; name=&quot;n4&quot;&gt;4&lt;/a&gt;&lt;/span&gt;==============================================================
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n5&quot; name=&quot;n5&quot;&gt;5&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;56&lt;/span&gt;                                           &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;def&lt;/span&gt; &lt;span style=&quot;color:#06B;font-weight:bold&quot;&gt;calculate_log_odds5&lt;/span&gt;(X, y):
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n6&quot; name=&quot;n6&quot;&gt;6&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;57&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;           &lt;span style=&quot;color:#00D&quot;&gt;13&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;13.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      log_odds = np.empty(X.shape[&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;])
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n7&quot; name=&quot;n7&quot;&gt;7&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;58&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;           &lt;span style=&quot;color:#00D&quot;&gt;47&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;47.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.1&lt;/span&gt;      class0_indices = y == &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;sorted&lt;/span&gt;(&lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;set&lt;/span&gt;(y))[&lt;span style=&quot;color:#00D&quot;&gt;0&lt;/span&gt;]
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n8&quot; name=&quot;n8&quot;&gt;8&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;59&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;          &lt;span style=&quot;color:#00D&quot;&gt;619&lt;/span&gt;    &lt;span style=&quot;color:#60E&quot;&gt;619.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.1&lt;/span&gt;      X = X.A
&lt;span class=&quot;line-numbers&quot;&gt; &lt;a href=&quot;#n9&quot; name=&quot;n9&quot;&gt;9&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;60&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2466&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1792&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.7&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;3.1&lt;/span&gt;      &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;for&lt;/span&gt; idx &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;in&lt;/span&gt; &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;range&lt;/span&gt;(X.shape[&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;]):
&lt;span class=&quot;line-numbers&quot;&gt;&lt;strong&gt;&lt;a href=&quot;#n10&quot; name=&quot;n10&quot;&gt;10&lt;/a&gt;&lt;/strong&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;61&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;8277&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;3.4&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;14.2&lt;/span&gt;          all_counts = X[:, idx]  &lt;span style=&quot;color:#777&quot;&gt;# document counts of this feature&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n11&quot; name=&quot;n11&quot;&gt;11&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;62&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;7354&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;3.0&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;12.6&lt;/span&gt;          total_counts = np.count_nonzero(all_counts)  &lt;span style=&quot;color:#777&quot;&gt;# how many docs the feature occurs in&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n12&quot; name=&quot;n12&quot;&gt;12&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;63&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;8044&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;3.3&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;13.8&lt;/span&gt;          count_in_class0 = np.count_nonzero(all_counts[class0_indices])  &lt;span style=&quot;color:#777&quot;&gt;# how many of them are class 0&lt;/span&gt;
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n13&quot; name=&quot;n13&quot;&gt;13&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;64&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;3521&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.4&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;6.1&lt;/span&gt;          p = &lt;span style=&quot;color:#369;font-weight:bold&quot;&gt;float&lt;/span&gt;(count_in_class0) / total_counts
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n14&quot; name=&quot;n14&quot;&gt;14&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;65&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;        &lt;span style=&quot;color:#00D&quot;&gt;25890&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;10.5&lt;/span&gt;     &lt;span style=&quot;color:#60E&quot;&gt;44.5&lt;/span&gt;          log_odds_this_feature = np.log(p) - np.log(&lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt; - p)
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n15&quot; name=&quot;n15&quot;&gt;15&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;66&lt;/span&gt;      &lt;span style=&quot;color:#00D&quot;&gt;2465&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;2623&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.1&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;4.5&lt;/span&gt;          log_odds[idx] = log_odds_this_feature
&lt;span class=&quot;line-numbers&quot;&gt;&lt;a href=&quot;#n16&quot; name=&quot;n16&quot;&gt;16&lt;/a&gt;&lt;/span&gt;    &lt;span style=&quot;color:#00D&quot;&gt;67&lt;/span&gt;         &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;            &lt;span style=&quot;color:#00D&quot;&gt;1&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;1.0&lt;/span&gt;      &lt;span style=&quot;color:#60E&quot;&gt;0.0&lt;/span&gt;      &lt;span style=&quot;color:#080;font-weight:bold&quot;&gt;return&lt;/span&gt; log_odds
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;

&lt;p&gt;The running time is now 0.05 seconds, or a speedup of ~50x. The bottleneck&lt;br /&gt;
operation is now entirely done on &lt;code&gt;numpy&lt;/code&gt; arrays, so there are no more&lt;br /&gt;
low-hanging fruit.&lt;/p&gt;

&lt;h4 id=&quot;notes&quot;&gt;Notes&lt;/h4&gt;
&lt;ul&gt;
  &lt;li&gt;Having unit tests for the functions that you are optimising is essential&lt;br /&gt;
to making sure nothing gets broken.&lt;/li&gt;
  &lt;li&gt;Functions to be profiled line by line cannot be typed into the interactive shell&lt;br /&gt;
and  must be imported from a file on disk&lt;/li&gt;
&lt;/ul&gt;
</description>
        <pubDate>Mon, 14 Jul 2014 15:52:58 +0100</pubDate>
        <link>http://mbatchkarov.github.io/2014/07/14/profiling-python/</link>
        <guid isPermaLink="true">http://mbatchkarov.github.io/2014/07/14/profiling-python/</guid>
        
        <category>python</category>
        
        <category>profiling</category>
        
        <category>performance</category>
        
        
      </item>
    
  </channel>
</rss>
