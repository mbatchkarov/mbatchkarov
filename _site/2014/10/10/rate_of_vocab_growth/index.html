<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>An exploration of scipy sparse matrices</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="Miroslav Batchkarov's webspace">
    <link rel="canonical" href="http://mbatchkarov.github.io/2014/10/10/rate_of_vocab_growth/">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/main.css">

    <script>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

        ga('create', 'UA-52813268-1', 'auto');
        ga('require', 'displayfeatures');
        ga('send', 'pageview');
    </script>
    
</head>


    <body>

    <header class="site-header">

  <div class="wrap">

    <a class="site-title" href="/">Miroslav Batchkarov</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        
          <a class="page-link" href="/blog/">Blog</a>
        
          <a class="page-link" href="/code/">Code</a>
        
          <a class="page-link" href="/contact/">Contact</a>
        
          
        
          
        
          <a class="page-link" href="/research/">Research</a>
        
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>An exploration of scipy sparse matrices</h1>
    <p class="meta">Oct 10, 2014</p>
  </header>

  <article class="post-content">
  <p>My colleague <a href="https://github.com/mattilyra">Matti Lyra</a> recently faced an
interesting computational problem.  He wanted to see how quickly a stream of
temporaly-ordered documents evolves, and he chose to do it by looking at how
often new words appear in the steam. This post is about how to do this
efficiently in Python.</p>

<p>More formally, the problem is: given a <a href="http://en.wikipedia.org/wiki/Document-term_matrix">term-document
matrix</a> (stored as a
<code>scipy.sparse.csc_matrix</code>), find how many new terms each document introduces as
efficiently as possible. Here is what we came up with.</p>

<p>First let’s generate some plausibly-looking (sparse) matrix to play with.</p>

<pre><code>import numpy as np
from scipy.sparse import csc_matrix

np.random.seed = 0
mat = csc_matrix(np.random.rand(10, 12)&gt;0.7, dtype=int)
mat[1, 0] = 2 # add some variety to the matrix
mat[0, 1] = 3
print(mat.A)

[[0 3 1 1 1 0 0 0 1 0 1 0]
 [2 0 1 1 0 0 0 0 0 1 1 1]
 [1 0 0 0 0 1 1 1 0 0 0 0]
 [0 1 0 0 1 0 0 0 0 1 1 0]
 [1 1 0 0 1 0 1 0 0 0 0 1]
 [0 0 1 0 0 0 1 0 0 0 0 0]
 [0 0 1 0 0 0 1 0 1 1 0 1]
 [0 1 0 1 0 1 0 0 0 0 1 0]
 [0 0 0 1 0 0 1 0 1 0 1 1]
 [0 0 0 0 0 0 1 0 1 1 0 1]]
</code></pre>

<p>The (sparse) matrix is stored as three dense arrays, <code>data</code>, <code>indices</code> and
<code>indptr</code>. <code>data</code> contains the non-zero values of the matrix, in the order in
which they would be encountered if we walked along the columns top to bottom and
left to right. If this were a <code>csr</code> matrix, the walk would have been along the
rows.</p>

<pre><code>mat.data[:10]
array([2, 1, 1, 3, 1, 1, 1, 1, 1, 1])
</code></pre>

<p>These numbers correspond to the non-zero values we would encounter if we walked
along the columns of the matrix. Note column boundaries are not marked- this is
what <code>indptr</code> is for. <code>indptr[i]</code> tell us where the <code>i</code>-th columns begins. For
the matrix above, we have</p>

<pre><code>mat.indptr[:10] # start and end index of each column in the data array
array([ 0,  3,  7, 11, 15, 18, 20, 26, 27, 31], dtype=int32)
</code></pre>

<p>So the first column starts at position <code>0</code> and runs until position <code>3</code>
(exclusive), the second columns starts at position <code>3</code> and runs until position
<code>7</code>, etc. Here are the non-zero values stored in the first and second column.</p>

<pre><code>print(mat.data[mat.indptr[0]:mat.indptr[1]])
print(mat.data[mat.indptr[1]:mat.indptr[2]])

[2 1 1]
[3 1 1 1]
</code></pre>

<p>What is still missing is what row these values should go in. This is stored in
<code>mat.indices</code>. We can index it similarty to how we index <code>mat.indptr</code>. To get
the rows in the first column where the non-zero values go, we would do this:</p>

<pre><code>print(mat.indices[:10]) # position of the data in a given row
print(mat.indices[mat.indptr[0]:mat.indptr[1]])

[1 2 4 0 3 4 7 0 1 5]
[1 2 4]
</code></pre>

<p>i.e. the non-zero rows in the first column are at positions 1, 2 and 4.</p>

<p>Let’s get back to our original problem of finding how many new terms appear in
each document. First, we want to find when (in what document) a term first
appears, i.e. the position of the first non-zero row in each column.
Fortunately, the <code>scipy.sparse.csc</code> format makes that very easy:</p>

<pre><code>first_nonzero_row = mat.indices[mat.indptr[:-1]]
first_nonzero_row
array([1, 0, 0, 0, 0, 2, 2, 2, 0, 1, 0, 1], dtype=int32)
</code></pre>

<p>Now that we know when words first appear, we want to find how many words appear
for the first time in each document:</p>

<pre><code>new_cols_per_row = np.bincount(first_nonzero_row, minlength=mat.shape[0])
print(new_cols_per_row)
[6 3 3 0 0 0 0 0 0 0]
</code></pre>

<p>And there you have it- <code>new_cols_per_row[i]</code> corresponds to how many new terms
appeared in the <code>i</code>-th document.</p>

<p>One trick we missed in our original implementation is the <code>minlength</code> parameter
to <code>bincount</code>. Without it <code>numpy</code> will get rid of bins (i.e. rows) with zero new
features, and the result will be smaller than what we would expect:</p>

<pre><code>np.bincount(first_nonzero_row)
array([6, 3, 3])
</code></pre>

<p>In the real text streams Matti works with, we didn’t find this to be a problem,
i.e. every document had at least one new term.</p>

  </article>

</div>
      </div>
    </div>

    <footer class="site-footer">

  <div class="wrap">

<!--     <h2 class="footer-heading">Miroslav Batchkarov</h2> -->

    <div class="footer-col-1 column">
      <ul>
        <li>Miroslav Batchkarov</li>
        <li><a href="mailto:mbatchkarov@gmail.com">mbatchkarov@gmail.com</a></li>
      </ul>
    </div>

    <div class="footer-col-2 column">
      <ul>
        <li>
          <a href="https://github.com/mbatchkarov">
            <span class="icon github">
              <svg version="1.1" class="github-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill-rule="evenodd" clip-rule="evenodd" fill="#C2C2C2" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761
                c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32
                c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472
                c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037
                C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65
                c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261
                c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082
                c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129
                c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/>
              </svg>
            </span>
            <span class="username">mbatchkarov</span>
          </a>
        </li>
        <li>
          <a href="https://twitter.com/loglinear">
            <span class="icon twitter">
              <svg version="1.1" class="twitter-icon-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                 viewBox="0 0 16 16" enable-background="new 0 0 16 16" xml:space="preserve">
                <path fill="#C2C2C2" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809
                c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27
                c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767
                c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206
                C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271
                c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469
                c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/>
              </svg>
            </span>
            <span class="username">loglinear</span>
          </a>
        </li>
      </ul>
    </div>


    <div class="footer-col-3 column">
      <!-- <p class="text">Miroslav Batchkarov's webspace</p> -->
      <a href="http://stackoverflow.com/users/419338/mbatchkarov">
       <img src="http://stackoverflow.com/users/flair/419338.png?theme=clean" height="38" alt="Profile for mbatchkarov at Stack Overflow">
      </a>
    </div>


  </div>

</footer>


    </body>
</html>